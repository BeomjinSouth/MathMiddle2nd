## PRD: Desmos 기반 기하 학습 도구 개선 (v1)

### 목적
- Desmos GraphingCalculator API를 기반으로 이등변삼각형/직각삼각형 RHA·RHS 학습을 안정적이고 일관되게 제공
- 코드와 문서의 불일치 해소, 타입/옵션/이벤트 사용을 Desmos API v1.11에 맞게 정비
- 학습 UX 개선(도구 안정성, 단계 안내, 검증 정확도)

### 범위
- 런타임: `index.html` 스크립트 로드, `src/components/Board/GeometryBoard.tsx` 초기화/이벤트, `src/state/lessonStore.ts`
- 검증: `src/utils/geometry/desmosValidators.ts`
- 스텝/툴링: `src/components/Sidebar/*`, `src/components/Toolbar/*`, `src/config/steps/*`
- 타입: `src/types/desmos.d.ts`

---

### 0. 사전 확인 (완료 기준: 체크리스트)
- [ ] Dev 서버에서 Desmos 스크립트 정상 로드 확인(콘솔 로그/에러 없음)
- [ ] 두 모듈(이등변, RHA/RHS) 모두 보드 렌더 및 포인트 드래그 가능
- [ ] 라우팅/페이지 전환 시 보드 destroy/재생성 문제 없음

---

### 1. Desmos 로딩 및 초기화 정합성
- 문제
  - `index.html`에서 API 스크립트 로드(onload/onerror 플래그 사용) + 컴포넌트 레벨 재시도 로직이 혼재
  - 옵션 키 일부가 문서와 다름(`settingsmenu` vs `settingsMenu` 등)
- 목표
  - 스크립트 로드 신뢰성 유지 + 컴포넌트의 재시도 로직 단순화
  - 옵션 키를 API 문서와 일치시켜 경고/의도치 않은 무시 방지
- 작업
  - `GeometryBoard`의 옵션 키 점검/수정: `settingsmenu` → `settingsMenu` 등 (Desmos API v1.11 표기)
  - 재시도 로직에서 `maxRetries`, 인터벌 상수화, 에러 메시지 한국어 일관화
  - destroy 호출 위치 및 타이밍 검증(언마운트/재마운트 시 리스너 누수 방지)
- 난이도: 하
- 수용 기준
  - [ ] `GraphingCalculator` 생성 옵션이 문서 명칭과 일치
  - [ ] 초기화 실패 시 50회 이내 재시도 후 명확한 에러 UI 노출
  - [ ] 페이지 전환(뒤/앞 이동)에서 메모리 누수/중복 리스너 경고 없음

---

### 2. 타입 정의 갱신 및 사용 안정화
- 문제
  - `src/types/desmos.d.ts` 일부 인터페이스/옵션 명명 케이스가 문서와 불일치 가능
  - `observeEvent` 시그니처가 느슨하며 커스텀 이벤트명 사용 시 타입 미보장
- 목표
  - 옵션/메서드/상수의 키 네이밍 문서와 일치, 안전한 콜 사이트 제공
- 작업
  - `CalculatorOptions` 필드 네이밍 재검증(`settingsMenu`, `expressionsTopbar`, `pointsOfInterest`, `qwertyKeyboard` 등) 및 수정
  - `observeEvent`에 제네릭/리터럴 타입 보강: `'change' | 'click'` 등 사용 위치 명확화
- 난이도: 중
- 수용 기준
  - [ ] 전 프로젝트 빌드 시 타입 에러 0건
  - [ ] 옵션 오타로 인해 무시되는 동작 없음(수동 테스트로 표현식 패널/키패드 토글)

---

### 3. 보드 이벤트/도구 처리 안정화
- 문제
  - 클릭/체인지 핸들러에서 `calculator.getExpressions()` 전수 파싱하여 좌표 반영 → 비용/정확성 이슈
  - 사용자 도구(선/선분/삭제) 동작 시 임시 표현식 정리 로직 분산
- 목표
  - 포인트 좌표 동기화를 더 견고하게(표현식 id/LaTeX 패턴 일관, 정규식 이스케이프 통일)
  - 임시 오브젝트 수명/추적(scratch.created) 일관화
- 작업
  - 포인트 라텍스 정규식 통일: `A=\left\(([-\d\.]+),([-\d\.]+)\right\)` 등 모듈화
  - `scratch.created`에 임시/툴 생성물을 모두 기록, 삭제/초기화 경로 단일화
  - 선/선분 생성 시 수직선 분기, 기울기/절편 반올림 정책 일관화
- 난이도: 중
- 수용 기준
  - [ ] 연속 드래그/생성/삭제 후 표현식 고아(id 미정리) 0건
  - [ ] 선/선분/삭제/포인트 생성 반복 시 콘솔 경고 없음

---

### 4. 검증기(Validators) 정확도/성능 개선
- 문제
  - 라텍스 파싱 기반으로 포인트/도형 감지 → 취약
  - 길이/각도 허용오차(px/deg) 변환 일관성 필요, 픽셀→수학 단위 근사 사용
- 목표
  - 파싱 정규식/좌표 수집 공통화, 허용오차 계산 경로 정리
- 작업
  - `getTrianglePoints` 유틸 단일화(중복 구현 제거: StepGuide/RHA 파일들과 validators 통합 util 모듈 도입)
  - 픽셀→수학 단위 변환에 `graphpaperBounds` 사용 고려(추가 개선안 v2로 분리, 현재는 일정 상 근사 유지)
  - 이등변/직각 검증 로직에 예외처리 강화(NaN/degenerate)
- 난이도: 중
- 수용 기준
  - [ ] 드래그 중 검증 버튼 스팸 시 오류/NaN 없음
  - [ ] 허용오차 변경 시 결과가 즉시 반영되고 과민 반응(플리킹) 없음

---

### 5. RHA/RHS 단계 UX 개선
- 문제
  - 단계별 제약 적용 로직(`applyConstraints`)이 일부 스텁 상태
  - 빗변/직각변 길이 픽셀 입력 → 수학 단위 변환 임시 비율 상수화
- 목표
  - 단계별 버튼이 실제 그래프 제약식(라텍스)으로 반영되고 시각 결과 확인 가능
- 작업
  - RHA 2단계: 빗변(A,B) 길이 제약 라텍스 보완 및 기존 제약 제거/갱신 정책 정립(id 고정)
  - RHS 3단계: 선택된 직각변 길이 제약 라텍스 적용(AC/BC 등 분기)
  - 우측하단 마커/도움말/겹쳐보기 토글 시 id 네임스페이스 `tool-*`, `overlay-*`로 일관화
- 난이도: 중
- 수용 기준
  - [ ] 각 단계 버튼 클릭 후 즉시 보드에 제약이 반영되고, 같은 단계에서 재클릭 시 중복 표현식 생성 없이 갱신
  - [ ] RHA 3단계/ RHS 3단계 완료 시 DoF=0 표시 일치

---

### 6. 접근성/로컬라이제이션 정비
- 문제
  - 언어 옵션 `language: 'ko'` 설정되어 있으나 일부 안내/버튼 텍스트 혼용 가능
- 목표
  - 한국어 일관 메시지, 에러/로딩 UI 개선
- 작업
  - 오류 UI(Desmos 미로딩/초기화 실패) 메시지/버튼 텍스트 통일
  - 툴팁 title/버튼 라벨 한국어 점검
- 난이도: 하
- 수용 기준
  - [ ] 한국어 외 텍스트 잔존 0건(의도적 영어 API/코드 제외)

---

### 7. 문서화/운영
- 문제
  - Desmos 가이드(두 md 파일)와 실제 사용의 차이점이 코드에 내재
- 목표
  - 프로젝트용 요약 사용 가이드 추가(설치/빌드/배포, API 핵심 옵션 요약)
- 작업
  - `README.md`에 Desmos 스크립트 로드 전략, 주요 옵션 표, 개발 체크리스트 추가
- 난이도: 하
- 수용 기준
  - [ ] 신규 개발자가 10분 내 로컬 구동/기능 확인 가능

---

### 릴리즈 노트(요약)
- Desmos 옵션/타입 정합성 정리, 이벤트/도구 안정화, 검증기 신뢰도 향상
- RHA/RHS 제약 적용 UX 개선, 에러/로딩 UI 한글화

### 롤백 계획
- 보드 초기화/옵션 변경 전 브랜치 보호, 변경 파일별 git revert 가이드 유지


